#!/bin/sh
#
# $Id$
#
# A script to invoke the MetaSOY! server and email the generated logs when it
# eventually exits.

NAME=msoy
DESC="MetaSOY world server"

MSOY_HOME=`dirname $0 | sed s:/bin$::`
MSOY_USER=www-data
HOSTNAME=`hostname`

# Make sure our nodename was and server pid file were properly supplied.
if [ -z "$1" -o -z "$2" ]; then
    echo "Usage: $0 nodename pid_file"
    exit 255
fi
PROCID=$1
PIDFILE=$2

LOGFILE=$MSOY_HOME/log/stdout-$PROCID.log
LOG_EMAIL=nightly-logs@threerings.net
SERVER_MEMORY=384M

# Override settings with those from MSOY_HOME/dist/msoy-server.conf
if [ -f $MSOY_HOME/dist/msoy-server.conf ]; then
    . $MSOY_HOME/dist/msoy-server.conf
else
    echo "Can't load $MSOY_HOME/dist/msoy-server.conf; can't run server."
    exit 255
fi

# Make sure we're running as the correct user
WHOAMI=`whoami`
if [ "$WHOAMI" != "$MSOY_USER" ]; then
    echo "This script must be run as $MSOY_USER."
    exit 255
fi

CLASS=com.threerings.msoy.server.MsoyServer
JAVA_ARGS="-server -mx$SERVER_MEMORY \
    -Dhostname=$HOSTNAME \
    -Dis_node=true \
    -Dresource_dir=$MSOY_HOME/rsrc \
    -Drsrc_cache_dir=/tmp \
    -Djava.security.manager -Djava.security.policy=$MSOY_HOME/dist/security.policy \
    -Djava.rmi.server.hostname=$HOSTNAME \
    -Dlog4j.configuration=log4j.properties \
    -Djava.util.logging.config.file=$MSOY_HOME/dist/logging.properties \
    -Dorg.apache.commons.logging.Log=org.apache.commons.logging.impl.Log4JLogger \
    -Dehcache.disk.store.dir=world \
    -Dskip_check_referrer=true"

# If we're running on dev1, add some JMX configuration
if [ "$PROCID" = "dev1" ]; then
    JAVA_ARGS="$JAVA_ARGS \
        -Dcom.sun.management.jmxremote.port=9988 \
        -Dcom.sun.management.jmxremote.authenticate=false \
        -Dcom.sun.management.jmxremote.ssl=false"
fi

# Make sure we have a JVM and set up our classpath and bits
. $MSOY_HOME/bin/runcommon

# Record the VM and arguments we're using (to the respawn log)
echo "Java VM: $JAVA_VM"
echo "Java args: $JAVA_ARGS"

# Create the logfile
touch $LOGFILE

# Change to the project root directory to avoid path funny business
cd $MSOY_HOME

# Start up the server
$JAVA_VM $JAVA_ARGS $CLASS >>$LOGFILE 2>&1 &
PROCESS_PID=$!
echo $PROCESS_PID >$PIDFILE
wait $PROCESS_PID
EXIT_CODE=$?

# If any stdout or stderr logs were generated, send those via email (all normal
# logs should be redirected to a separate file)
if [ -s $LOGFILE ]; then
    cat $LOGFILE | $MAIL -s "$HOSTNAME: $MSOY_HOME stray log output" $LOG_EMAIL
fi
rm -f $LOGFILE

exit $EXIT_CODE

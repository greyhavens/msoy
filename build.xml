<!-- build configuration -->
<project name="msoy" default="compile" basedir="." xmlns:artifact="urn:maven-artifact-ant">

  <!-- define some basic project parameters -->
  <property name="app.name"     value="msoy"/>

  <!-- things you probably don't want to change -->
  <property name="src.dir"       value="src/java"/>
  <property name="gsrc.dir"      value="src/gwt"/>
  <property name="asrc.dir"      value="src/as"/>
  <property name="deploy.dir"    value="dist"/>
  <property name="classes.dir"   value="${deploy.dir}/classes"/>
  <property name="gwtout.dir"    value="pages/gwt"/>
  <property name="flexsdk.dir"   value="lib/flex_sdk"/>
  <property name="extlibs.dir"   value="extlibs/java"/>
  <property name="javadoc.title" value="Metasoy API"/>

  <!-- define various packaging properties -->
  <property name="msoy.user"        value="_msoy"/>
  <property name="burl.user"        value="_burl"/>
  <property name="msoy.group"       value="_msoy"/>
  <property name="maintainer.name"  value="Three Rings Design"/>
  <property name="maintainer.email" value="msoy-dev@threerings.net"/>

  <!-- defines the build version (normally zero unless we're doing a package build) -->
  <property name="version" value="0"/>

  <!-- define our subprojects and include the standard build system -->
  <property name="projects" value="facebook,thane"/>
  <import file="build/etc/build-support.xml"/>
  <fileset dir="." id="check.paths">
    <include name="${src.dir}/**/*.java"/>
    <exclude name="${src.dir}/**/data/*Marshaller.java"/>
    <exclude name="${src.dir}/**/server/*Provider.java"/>
    <exclude name="${src.dir}/**/server/*Dispatcher.java"/>
    <include name="${gsrc.dir}/client/**/*.java"/>
    <exclude name="${gsrc.dir}/**/*Messages.java"/>
    <exclude name="${gsrc.dir}/client/images/**/*Images.java"/>
  </fileset>

  <!-- override the src dirset and package names for the common javadoc target -->
  <property name="javadoc.pkg.names" value="client.*,com.threerings.msoy.*"/>
  <path id="javadoc.src.path">
    <!-- TODO make this only look for bits inside of client/ -->
    <dirset dir="${gsrc.dir}">
      <exclude name="**/.svn"/>
    </dirset>
    <dirset dir="${src.dir}">
      <exclude name="**/.svn"/>
    </dirset>
  </path>

  <!-- declare the libraries needed by the MSOY runtime -->
  <filelist dir="." id="dist.libs">
    <file name="${extlibs.dir}/activation.jar"/>
    <file name="${extlibs.dir}/aopalliance.jar"/>
    <file name="${extlibs.dir}/args4j-2.0.7.jar"/>
    <file name="${extlibs.dir}/commons-beanutils.jar"/>
    <file name="${extlibs.dir}/commons-codec.jar"/>
    <file name="${extlibs.dir}/commons-collections.jar"/>
    <file name="${extlibs.dir}/commons-digester.jar"/>
    <file name="${extlibs.dir}/commons-fileupload.jar"/>
    <file name="${extlibs.dir}/commons-httpclient.jar"/>
    <file name="${extlibs.dir}/commons-io.jar"/>
    <file name="${extlibs.dir}/commons-lang.jar"/>
    <file name="${extlibs.dir}/commons-logging.jar"/>
    <file name="${extlibs.dir}/ehcache-1.2.jar"/>
    <file name="${extlibs.dir}/ganymed.jar"/>
    <file name="${extlibs.dir}/getdown.jar"/>
    <file name="${extlibs.dir}/google-collect.jar"/>
    <file name="${extlibs.dir}/guice.jar"/>
    <file name="${extlibs.dir}/gwt-user.jar"/>
    <file name="${extlibs.dir}/gwt-dnd.jar"/>
    <file name="${extlibs.dir}/gwt-widgets.jar"/>
    <file name="${extlibs.dir}/javassist.jar"/>
    <file name="${extlibs.dir}/jcip-annotations.jar"/>
    <file name="${extlibs.dir}/jetty6/jetty-util.jar"/>
    <file name="${extlibs.dir}/jetty6/jetty.jar"/>
    <file name="${extlibs.dir}/junit-3.7.jar"/>
    <file name="${extlibs.dir}/junit4.jar"/>
    <file name="${extlibs.dir}/mail.jar"/>
    <file name="${extlibs.dir}/mina-core.jar"/>
    <file name="${extlibs.dir}/mina-filter-ssl.jar"/>
    <file name="${extlibs.dir}/mysql-connector-java.jar"/>
    <file name="${extlibs.dir}/postgresql-jdbc.jar"/>
    <file name="${extlibs.dir}/proguard.jar"/>
    <file name="${extlibs.dir}/quartz.jar"/>
    <file name="${extlibs.dir}/redstone-xmlrpc-client.jar"/>
    <file name="${extlibs.dir}/redstone-xmlrpc.jar"/>
    <file name="${extlibs.dir}/retroweaver-all-1.2.2.jar"/>
    <file name="${extlibs.dir}/retroweaver-rt-1.2.2.jar"/>
    <file name="${extlibs.dir}/s3lib.jar"/>
    <file name="${extlibs.dir}/servlet-api.jar"/>
    <file name="${extlibs.dir}/slf4j-api.jar"/>
    <file name="${extlibs.dir}/slf4j-log4j12.jar"/>
    <file name="${extlibs.dir}/svnClientAdapter.jar"/>
    <file name="${extlibs.dir}/svnjavahl.jar"/>
    <file name="${extlibs.dir}/svnkit-cli.jar"/>
    <file name="${extlibs.dir}/svnkit-javahl.jar"/>
    <file name="${extlibs.dir}/svnkit.jar"/>
    <file name="${extlibs.dir}/swfutils-ooo.jar"/>
    <file name="${extlibs.dir}/velocity-1.5-dev.jar"/>
    <file name="${extlibs.dir}/ws-commons-util.jar"/>
    <file name="${extlibs.dir}/xmlrpc-client.jar"/>
    <file name="${extlibs.dir}/xmlrpc-common.jar"/>
    <file name="${extlibs.dir}/rabbitmq-client.jar"/>

    <!-- The following are used for Panopticon -->
    <file name="${extlibs.dir}/log4j.jar"/>
    <file name="${extlibs.dir}/hessian.jar"/>

    <!-- The following are used for HTML sanitization -->
    <file name="${extlibs.dir}/antisamy/antisamy-bin.1.0.jar"/>
    <file name="${extlibs.dir}/antisamy/batik-css.jar"/>
    <file name="${extlibs.dir}/antisamy/batik-util.jar"/>
    <file name="${extlibs.dir}/antisamy/dom4j.jar"/>
    <file name="${extlibs.dir}/antisamy/nekohtml.jar"/>
    <file name="${extlibs.dir}/antisamy/sac.jar"/>
    <file name="${extlibs.dir}/xercesImpl.jar"/>

    <file name="lib/json.jar"/>
    <file name="lib/jswiff-8.0-beta-2-threerings.jar"/>
    <file name="lib/sdoc-0.5.0-beta-ooo.jar"/>
    <file name="lib/substance-lite.jar"/>

    <file name="lib/lwjgl-applet.jar"/>

    <!-- The following are used for aperture -->
    <file name="lib/aperture/aperture-2006.1-alpha-3.jar"/>
    <file name="lib/aperture/aperture-test-2006.1-alpha-3.jar"/>
    <file name="lib/aperture/applewrapper-0.1.jar"/>
    <file name="lib/aperture/bcmail-jdk14-132.jar"/>
    <file name="lib/aperture/bcprov-jdk14-132.jar"/>
    <file name="lib/aperture/demork-2.0.jar"/>
    <file name="lib/aperture/fontbox-0.1.0-dev.jar"/>
    <file name="lib/aperture/htmlparser-1.6.jar"/>
    <file name="lib/aperture/ical4j-cvs20061019.jar"/>
    <file name="lib/aperture/jacob-1.10-pre4.jar"/>
    <file name="lib/aperture/openrdf-model-2.0-alpha-3.jar"/>
    <file name="lib/aperture/openrdf-util-2.0-alpha-3.jar"/>
    <file name="lib/aperture/openrdf-util-crazy-debug.jar"/>
    <file name="lib/aperture/openrdf-util-fixed-locking.jar"/>
    <file name="lib/aperture/pdfbox-0.7.3.jar"/>
    <file name="lib/aperture/poi-3.0-alpha2-20060616.jar"/>
    <file name="lib/aperture/poi-contrib-3.0-alpha2-20060616.jar"/>
    <file name="lib/aperture/poi-scratchpad-3.0-alpha2-20060616.jar"/>
    <file name="lib/aperture/rio-2.0-alpha-3.jar"/>
    <file name="lib/aperture/sesame-2.0-alpha-3.jar"/>
    <file name="lib/aperture/winlaf-0.5.1.jar"/>

    <!-- The following are used for webmail address book importing -->
    <file name="${extlibs.dir}/abimporter.jar"/>
    <file name="${extlibs.dir}/ozcommons.jar"/>

    <!-- The following are used by our Flash clients -->
    <file name="lib/corelib.swc"/>
    <file name="lib/flexlib.swc"/>
    <file name="lib/tweener.swc"/>

    <!-- The following are used to build abc files -->
    <file name="${extlibs.dir}/asc.jar"/>
    <file name="${extlibs.dir}/flexTasks.jar"/>
  </filelist>

  <!-- fetches our library dependencies -->
  <target name="mavendeps" depends="prepare">
    <artifact:dependencies filesetId="dependency.fileset">
      <remoteRepository refid="ooo.maven.depends.repo"/>
      <dependency groupId="com.threerings.panopticon" artifactId="panopticon-client"
                  version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings.narya" artifactId="narya-base" version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings.narya" artifactId="narya-distrib" version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings.narya" artifactId="naryalib" version="0.0-SNAPSHOT"
                  type="swc"/>
      <dependency groupId="com.threerings.narya" artifactId="player-env" version="0.0-SNAPSHOT"
                  type="swc"/>
      <dependency groupId="com.threerings.narya" artifactId="thane-env" version="0.0-SNAPSHOT"
                  type="swc"/>
      <dependency groupId="com.threerings.nenya" artifactId="nenya-rsrc" version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings.nenya" artifactId="nenya-media" version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings.nenya" artifactId="nenyalib" version="0.0-SNAPSHOT"
                  type="swc"/>
      <dependency groupId="com.threerings.vilya" artifactId="vilya-parlor" version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings.vilya" artifactId="vilya-whirled" version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings.vilya" artifactId="vilya-stats" version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings.vilya" artifactId="vilya-micasa" version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings.vilya" artifactId="vilyalib" version="0.0-SNAPSHOT"
                  type="swc"/>
      <dependency groupId="com.threerings" artifactId="whirled-code" version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings" artifactId="whirledlib" version="0.0-SNAPSHOT"
                  type="swc"/>
      <dependency groupId="com.threerings" artifactId="whirledthanelib" version="0.0-SNAPSHOT"
                  type="swc"/>
      <dependency groupId="com.threerings" artifactId="threerings" version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings" artifactId="threerings-gwt" version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings" artifactId="toybox" version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings" artifactId="toyboxlib" version="0.0-SNAPSHOT"
                  type="swc"/>
      <dependency groupId="com.threerings.underwire" artifactId="underwire" version="0.0-SNAPSHOT"/>
      <dependency groupId="com.threerings.underwire" artifactId="underwire-gwt"
                  version="0.0-SNAPSHOT"/>
      <dependency groupId="org.jivesoftware.smack" artifactId="smack-component"
                  version="0.0-SNAPSHOT"/>
    </artifact:dependencies>
    <copy todir="${deploy.dir}/lib">
      <fileset refid="dependency.fileset"/>
      <mapper type="flatten"/>
    </copy>
  </target>

  <!-- enumerate our translation files -->
  <property name="msgs1.list" value="shell.Shell,account.Account,adminz.Admin,shop.Shop"/>
  <property name="msgs2.list" value="games.Games,whirleds.Whirleds,stuff.Stuff,editem.Editem"/>
  <property name="msgs3.list" value="item.Item,mail.Mail,msgs.Msgs,people.People,swiftly.Swiftly"/>
  <property name="msgs4.list" value="room.Room,rooms.Rooms,me.Me,remix.Remix,help.Help"/>
  <property name="msgs5.list" value="support.Support,landing.Landing,person.Person"/>
  <property name="msgs6.list" value="shell.Dynamic,shell.Server"/>
  <property name="msgsN.list" value="${msgs1.list},${msgs2.list},${msgs3.list},${msgs4.list}"/>
  <property name="gmsgs.list" value="${msgsN.list},${msgs5.list},${msgs6.list}"/>

  <!-- enumerate our GWT pages -->
  <property name="pages1.list" value="account,adminz,games,help,landing,mail,me,people"/>
  <property name="pages2.list" value="rooms,shop,stuff,support,swiftly,whirleds"/>
  <property name="gpages.list" value="frame,${pages1.list},${pages2.list}"/>

  <!-- declare our classpath -->
  <path id="classpath">
    <pathelement location="${classes.dir}"/>
    <fileset dir="${deploy.dir}/lib" includes="*.jar"/>
    <fileset dir="lib" includes="plugin.jar"/>
  </path>

  <!-- gets our various properties files and sticks them in dist -->
  <target name="config">
    <mkdir dir="${deploy.dir}"/>

    <!-- grab the deployment et al properties from the configuration location. -->
    <gatherconfiguration app="${app.name}" distribution="${ooo.distribution}" dest="${deploy.dir}">
      <sources refid="ooo.msoyconfig.source"/>
      <sources><directory path="${basedir}/etc"/></sources>
      <files>
        <file name="msoy-server.properties"/>
        <file name="msoy-server.conf"/>
        <file name="burl-server.properties"/>
        <file name="burl-server.conf"/>
        <file name="build_settings.properties"/>
      </files>
    </gatherconfiguration>

    <!-- Read in all the deployment & build configuration bits. -->
    <property file="${deploy.dir}/msoy-server.properties"/>
    <property file="${deploy.dir}/build_settings.properties"/>
  </target>

  <!-- prepares the application directories -->
  <target name="prepare" depends="config">
    <mkdir dir="${deploy.dir}/lib"/>
    <mkdir dir="${deploy.dir}/tmp"/>
    <mkdir dir="${classes.dir}"/>
    <mkdir dir="${classes.dir}/rsrc"/>
    <copy todir="${classes.dir}/rsrc">
      <fileset dir="rsrc">
       <include name="**/*"/>
      </fileset>
    </copy>

    <!-- Copy all the libs we depend on. -->
    <copyfilelist dest="${deploy.dir}/lib">
      <filelist refid="dist.libs"/>
    </copyfilelist>

    <!-- create our toybox propertis from msoy-server.properties -->
    <exec executable="egrep">
      <arg line="^toybox\."/>
      <arg line="${deploy.dir}/msoy-server.properties"/>
      <redirector output="${classes.dir}/toybox.properties">
        <outputfilterchain>
          <replacestring from="toybox." to=""/>
        </outputfilterchain>
      </redirector>
    </exec>

    <!-- copy a few configuration files into place -->
    <copy todir="${deploy.dir}" file="${basedir}/etc/logging.properties"/>
    <copy tofile="${deploy.dir}/log4j-game.properties" file="${basedir}/${log4j_game_config}"/>
    <copy tofile="${deploy.dir}/log4j.properties" file="${basedir}/${log4j_config}"/>
    <copy tofile="${deploy.dir}/log4j-bureaulauncher.properties"
          file="${basedir}/${log4j_bureau_config}"/>
    <copy tofile="${deploy.dir}/ehcache.xml" file="${basedir}/${ehcache_config}"/>

    <!-- generate our index.html and crossdomain.xml -->
    <propertyregex property="server_url_host" input="${server_url}"
                   regexp="http://([^:]*)(:[0-9]+)?/" replace="\1"/>
    <copy file="pages/index.html.in" tofile="pages/index.html" overwrite="true">
      <filterset>
        <filter token="SERVER_URL" value="${server_url}"/>
        <filter token="SERVER_URL_HOST" value="${server_url_host}"/>
      </filterset>
    </copy>
    <propertyregex property="server_url_host" input="${server_url}"
                   regexp="http://([^:/]*):?.*" replace="\1"/>
    <propertyregex property="media_url_host" input="${media_url}"
                   regexp="http://([^:/]*):?.*" replace="\1"/>
    <copy file="pages/crossdomain.xml.in" tofile="pages/crossdomain.xml" overwrite="true">
      <filterset>
        <filter token="SERVER_URL_HOST" value="${server_url_host}"/>
        <filter token="MEDIA_URL_HOST" value="${media_url_host}"/>
        <filter token="HTTP_PORT" value="${http_port}"/>
      </filterset>
    </copy>

    <!-- copy our HTML sanitizer configuration -->
    <copy file="${basedir}/etc/antisamy-config.xml" todir="${deploy.dir}"/>

    <!-- create dev usable security.policy and swiftly.policy files -->
    <!-- real ones are created in package -->
    <copy file="etc/security.policy.in" tofile="${deploy.dir}/security.policy" overwrite="true">
      <filterset><filter token="PREFIX" value="${server_root}"/></filterset>
    </copy>
    <copy file="etc/swiftly.policy.in" tofile="${deploy.dir}/swiftly.policy" overwrite="true">
      <filterset><filter token="PREFIX" value="${basedir}"/></filterset>
    </copy>
  </target>

  <!-- runs the GWT debugging shell -->
  <target name="gshell" depends="config">
    <available property="gwtdir.present" file="lib/gwt"/>
    <fail message="You must symlink 'lib/gwt' to a current GWT distribution."
          unless="gwtdir.present"/>

    <path id="gwt.classpath">
      <pathelement location="${src.dir}"/>
      <pathelement location="${gsrc.dir}"/>
      <pathelement location="${classes.dir}"/>
      <fileset dir="${deploy.dir}/lib">
        <include name="gwt-widgets.jar"/>
        <include name="*-gwt-0.0-SNAPSHOT.jar"/>
      </fileset>
      <fileset dir="lib/gwt" includes="*.jar"/>
    </path>
    <available property="gwt.present" classname="com.google.gwt.dev.GWTShell"
               classpathref="gwt.classpath"/>
    <fail message="You must symlink 'lib/gwt' to a current GWT distribution." unless="gwt.present"/>
    <fail message="You must specify -Dpage=(mail|stuff|shop|etc.)." unless="page"/>

    <!-- we need to copy our .gwt.xml into place while gshell is running -->
    <copy file="${gsrc.dir}/${page}.gwt.xml.in" tofile="${gsrc.dir}/${page}.gwt.xml"
          overwrite="true"/>

    <if><equals arg1="${platform.darwin}" arg2="true"/><then>
      <java classpathref="gwt.classpath" fork="true" maxmemory="256M"
            classname="com.google.gwt.dev.GWTShell">
        <jvmarg value="-XstartOnFirstThread"/>
        <arg value="-noserver"/>
        <arg value="-port"/>
        <arg value="${http_port}"/>
        <arg value="-out"/>
        <arg value="${gwtout.dir}"/>
        <arg value="gwt/${page}/${page}.html"/>
      </java>
    </then><else>
      <java classpathref="gwt.classpath" fork="true" maxmemory="256M"
            classname="com.google.gwt.dev.GWTShell">
        <arg value="-noserver"/>
        <arg value="-port"/>
        <arg value="${http_port}"/>
        <arg value="-out"/>
        <arg value="${gwtout.dir}"/>
        <arg value="gwt/${page}/"/>
      </java>
    </else></if>

    <!-- now delete our temporary .gwt.xml file -->
    <delete file="${gsrc.dir}/@{page}.gwt.xml"/>
  </target>

  <!-- regenerates our i18n messages classes -->
  <target name="gmsgs">
    <uptodate property="gmsgs.uptodate">
      <srcfiles dir= "${gsrc.dir}" includes="client/*/*Messages.properties"/>
      <mapper type="glob" from="*.properties" to="*.java"/>
    </uptodate>
    <if><not><isset property="gmsgs.uptodate"/></not><then>
      <for list="${gmsgs.list}" param="which"><sequential>
        <echo>Regenerating Java for @{which}Messages.properties...</echo>
        <java fork="true" classname="com.google.gwt.i18n.tools.I18NSync">
          <classpath>
            <fileset dir="${extlibs.dir}" includes="gwt-user.jar"/>
            <fileset dir="${extlibs.dir}" includes="gwt-dev-*.jar"/>
            <pathelement location="${gsrc.dir}"/>
          </classpath>
          <arg value="-createMessages"/>
          <arg value="-out"/>
          <arg value="${gsrc.dir}"/>
          <arg value="client.@{which}Messages"/>
        </java>
      </sequential></for>
    </then></if>
    <exec executable="${basedir}/bin/unfuckmsgs.sh" failonerror="true"/>
  </target>

  <!-- prepares to build our GWT client -->
  <target name="jprepare" depends="prepare">
    <tstamp>
      <format property="build_time" pattern="yyyy-MM-dd HH:mm:ss"/>
    </tstamp>
    <!-- set default properties -->
    <property name="dev_deployment" value="true"/>
    <!-- fucking ant -->
    <if><isset property="recaptcha_public"/><then>
      <property name="recaptcha_token" value="${recaptcha_public}"/>
    </then><else>
      <property name="recaptcha_token" value=""/>
    </else></if>
    <!-- then overwrite with values read from msoy-server.properties -->
    <copy file="${src.dir}/com/threerings/msoy/data/all/DeploymentConfig.java.tmpl"
          tofile="${src.dir}/com/threerings/msoy/data/all/DeploymentConfig.java" overwrite="true">
      <filterset>
        <filter token="build_time" value="${build_time}"/>
        <filter token="build_version" value="${version}"/>
        <filter token="server_url" value="${server_url}"/>
        <filter token="media_url" value="${media_url}"/>
        <filter token="static_media_url" value="${static_media_url}"/>
        <filter token="dev_deployment" value="${dev_deployment}"/>
        <filter token="recaptcha_public" value="${recaptcha_token}"/>
        <filter token="billing_url" value="${billing_url}"/>
      </filterset>
    </copy>
  </target>

  <!-- builds our numerous GWT web clients -->
  <property name="pages" value="${gpages.list}"/>
  <target name="gclient" depends="jprepare,gmsgs"
          description="Rebuilds the GWT client (but only for Mozilla).">
    <property name="pageout.dir" value="${gwtout.dir}/${version}"/>
    <mkdir dir="${pageout.dir}"/>
    <for list="${pages}" param="page" parallel="true" threadCount="${gwt_build_threads}"><sequential>
      <delete dir="${pageout.dir}/@{page}"/>
      <mkdir dir="${pageout.dir}/@{page}"/>
      <if><isset property="gwt_user_agent"/><then>
          <echo>Building GWT clients for: ${gwt_user_agent}...</echo>
          <exec executable="bin/quickify" failonerror="true">
            <arg value="${gsrc.dir}/@{page}.gwt.xml"/>
            <arg value="${gwt_user_agent}"/>
          </exec>
        </then><else>
          <copy file="${gsrc.dir}/@{page}.gwt.xml.in"
                tofile="${gsrc.dir}/@{page}.gwt.xml" overwrite="true"/>
      </else></if>
      <java fork="true" maxmemory="1024M" failonerror="false" resultproperty="gwt.result"
            classname="com.google.gwt.dev.GWTCompiler">
        <classpath>
          <fileset dir="${extlibs.dir}" includes="gwt-dev-*.jar"/> <!-- the GWT compiler -->
          <fileset dir="${deploy.dir}/lib">
            <include name="gwt-user.jar"/>
            <include name="gwt-widgets.jar"/>
            <include name="*-gwt-0.0-SNAPSHOT.jar"/>
            <!-- this is needed to run our custom i18n bindings in the GWT compiler -->
            <include name="threerings-0.0-SNAPSHOT.jar"/>
            <include name="gwt-dnd.jar"/>
          </fileset>
          <pathelement location="${src.dir}"/>
          <pathelement location="${gsrc.dir}"/>
        </classpath>
        <arg value="-style"/><arg value="${gwt_style}"/>
        <arg value="-out"/>
        <arg value="${pageout.dir}"/>
        <arg value="@{page}"/>
        <!-- gather all the compiler output into a property -->
        <redirector outputproperty="redirector.out"/>
      </java>

      <!-- delete our temporary .gwt.xml file -->
      <delete file="${gsrc.dir}/@{page}.gwt.xml"/>

      <!-- until the GWT compiler does the right thing echo errors/warnings correctly -->
      <if><contains string="${redirector.out}" substring="[ERROR]"/><then>
          <echo level="error">${redirector.out}</echo>
          <!-- be really, really sure that the build fails if we get an error logs -->
          <property name="has.errors" value="true"/>
        </then><elseif><contains string="${redirector.out}" substring="[WARNING]"/><then>
            <echo level="warning">${redirector.out}</echo>
        </then></elseif><else>
          <echo level="info">${redirector.out}</echo>
      </else></if>

      <!-- fail the build if the GWT compiler returned 1 or errors were detected -->
      <fail message="The GWT build failed. See output for details.">
        <condition><or>
            <equals arg1="${gwt.result}" arg2="1"/>
            <isset property="has.errors"/>
        </or></condition>
      </fail>

      <!-- if we succeeded, gzip our generated HTML output -->
      <apply failonerror="true" executable="gzip">
        <arg value="-c"/>
        <srcfile/>
        <fileset dir="${pageout.dir}/@{page}" includes="*.cache.html"/>
        <redirector>
          <outputmapper type="glob" from="*.cache.html" to="${pageout.dir}/@{page}/*.cache.html.gz"/>
        </redirector>
      </apply>

      <!-- if we're building the 'frame' page, we need to move it up out of the version dir -->
      <if><equals arg1="@{page}" arg2="frame"/><then>
        <move file="${pageout.dir}/@{page}" todir="${gwtout.dir}"/>
      </then></if>

      <!-- clear out some variables -->
      <var name="gwt.result" unset="true"/>
      <var name="redirector.out" unset="true"/>
      <var name="has.errors" unset="true"/>
    </sequential></for>
  </target>

  <!-- prepares to build our Flash client -->
  <target name="asprepare" depends="prepare">
    <mkdir dir="pages/clients/${version}"/>
    <tstamp>
      <format property="build_time" pattern="yyyy-MM-dd HH:mm:ss"/>
    </tstamp>
    <!-- set default properties -->
    <property name="dev_deployment" value="true"/>
    <property name="socket_policy_port" value="47623"/>
    <property name="log_levels_config" value=""/>
    <!-- then overwrite with values read from msoy-server.properties -->
    <copy file="${asrc.dir}/com/threerings/msoy/client/DeploymentConfig.as.tmpl"
          tofile="${asrc.dir}/com/threerings/msoy/client/DeploymentConfig.as"
          overwrite="true">
      <filterset>
        <filter token="build_time" value="${build_time}"/>
        <filter token="build_version" value="${version}"/>
        <filter token="server_host" value="${server_host}"/>
        <filter token="server_ports" value="${server_ports}"/>
        <filter token="socket_policy_port" value="${socket_policy_port}"/>
        <filter token="server_url" value="${server_url}"/>
        <filter token="media_url" value="${media_url}"/>
        <filter token="dev_deployment" value="${dev_deployment}"/>
        <filter token="static_media_url" value="${static_media_url}"/>
        <filter token="log_levels_config" value="${log_levels_config}"/>
        <filter token="billing_url" value="${billing_url}"/>
      </filterset>
    </copy>
  </target>

  <!-- just rebuilds the Flash client, assumes nothing has changed -->
  <property name="astype" value="world"/>
  <property name="flex.debug-arg" value="-externs=DummyValueIgnore"/>
  <target name="ascompile">
    <!-- set default properties -->
    <property name="dev_deployment" value="true"/>
    <exec executable="${basedir}/bin/mxmlc" failonerror="true">
      <arg value="-load-config"/>
      <arg value="etc/msoy-config.xml"/>
      <arg value="${flex.debug-arg}"/>
      <arg value="-compiler.source-path=${asrc.dir}/"/>
      <arg value="-compiler.source-path=rsrc/{locale}/i18n"/>
      <arg value="-compiler.verbose-stacktraces=${dev_deployment}"/>
      <!-- This sets the SWF size, not the app size, and we set it to
           this size for the avatar viewer's native size. -->
      <arg value="-default-size"/>
      <arg value="600"/>
      <arg value="488"/>
      <arg value="-incremental=true"/>
      <arg value="-output"/>
      <arg value="${deploy.dir}/${astype}-client.swf"/>
      <arg value="-file-specs"/>
      <arg value="${asrc.dir}/${astype}.mxml"/>
    </exec>
    <copy file="${deploy.dir}/${astype}-client.swf" todir="pages/clients/${version}"/>
  </target>

  <target name="generate-link-report">
    <xslt in="/tmp/link-report.xml" out="link-report.html" style="etc/link-report.xsl"/>
  </target>

  <!-- builds our Flash world client -->
  <target name="asclient" depends="asprepare" description="Rebuilds the Flash world client.">
    <antcall target="ascompile"><param name="astype" value="world"/></antcall>
  </target>

  <!-- builds our Flash game client -->
  <target name="asgclient" depends="asprepare" description="Rebuilds the Flash game client.">
    <antcall target="ascompile"><param name="astype" value="game"/></antcall>
  </target>

  <!-- builds our Flash debug client -->
  <target name="asdebug" depends="asprepare">
    <antcall target="ascompile"><param name="flex.debug-arg" value="-compiler.debug"/></antcall>
  </target>

  <!-- builds our thane game client -->
  <target name="thane-client" depends="asprepare" description="Rebuilds the thane game client.">
    <dirname property="abs.flexsdk.dir" file="${flexsdk.dir}/somefile.txt"/>
    <copy file="etc/thane-config.xml.in" tofile="${deploy.dir}/thane-config.xml">
      <filterset>
        <filter token="flex_sdk_dir" value="${abs.flexsdk.dir}"/>
      </filterset>
    </copy>
    <!-- create msoylib.swc to hold the entire set of dependent classes -->
    <java jar="${flexsdk.dir}/lib/compc.jar" fork="true" failonerror="true">
      <arg value="-load-config"/>
      <arg value="dist/thane-config.xml"/>
      <arg value="-compiler.external-library-path"/>
      <arg value="${deploy.dir}/lib/thane.swc"/>
      <arg value="-compiler.library-path"/>
      <arg value="${deploy.dir}/lib/http.swc"/>
      <arg value="${deploy.dir}/lib/thane-env-0.0-SNAPSHOT.swc"/>
      <arg value="${deploy.dir}/lib/naryalib-0.0-SNAPSHOT.swc"/>
      <arg value="${deploy.dir}/lib/nenyalib-0.0-SNAPSHOT.swc"/>
      <arg value="${deploy.dir}/lib/vilyalib-0.0-SNAPSHOT.swc"/>
      <arg value="${deploy.dir}/lib/whirledlib-0.0-SNAPSHOT.swc"/>
      <arg value="${deploy.dir}/lib/whirledthanelib-0.0-SNAPSHOT.swc"/>
      <arg value="-output"/>
      <arg value="${deploy.dir}/msoylib.swc"/>
      <arg value="-compiler.source-path"/>
      <arg value="src/thane"/>
      <arg value="src/as"/>
      <arg value="-include-sources=src/thane/Reference.as"/>
    </java>

    <!-- link the executable -->
    <java jar="${flexsdk.dir}/lib/mxmlc.jar" fork="true" failonerror="true">
      <arg value="-load-config"/>
      <arg value="dist/thane-config.xml"/>
      <arg value="-compiler.external-library-path"/>
      <arg value="${deploy.dir}/lib/thane.swc"/>
      <arg value="${deploy.dir}/msoylib.swc"/>
      <arg value="-compiler.source-path=src/thane"/>
      <arg value="-output"/>
      <arg value="${deploy.dir}/MsoyThaneClient.swf"/>
      <arg value="src/thane/MsoyThaneClient.as"/>
    </java>

    <echo message="Turning .swfs into .abcs..."/>
    <java outputproperty="dump" classpathref="classpath"
          classname="flash.swf.tools.SwfxPrinter" fork="true" failonerror="true">
      <arg value="-dump"/>
      <arg value="${deploy.dir}/msoylib.abc"/>
      <arg value="${deploy.dir}/msoylib.swc"/>
    </java>
    <java outputproperty="dump" classpathref="classpath"
          classname="flash.swf.tools.SwfxPrinter" fork="true" failonerror="true">
      <arg value="-dump"/>
      <arg value="${deploy.dir}/MsoyThaneClient.abc"/>
      <arg value="${deploy.dir}/MsoyThaneClient.swf"/>
    </java>
  </target>

  <!-- builds the mediastub that's used to wrap SWF media -->
  <target name="mediastub">
    <exec executable="${basedir}/bin/mxmlc" failonerror="true">
      <arg value="-load-config"/>
      <arg value="etc/msoy-config.xml"/>
      <arg value="-compiler.source-path=${asrc.dir}/"/>
      <arg value="-output"/>
      <arg value="${deploy.dir}/MediaStub.swf"/>
      <arg value="-file-specs"/>
      <arg value="${asrc.dir}/com/threerings/msoy/room/client/MediaStub.as"/>
    </exec>
    <copy file="${deploy.dir}/MediaStub.swf" todir="pages/media"/>
  </target>

  <target name="embedstub">
    <exec executable="${basedir}/bin/mxmlc" failonerror="true">
      <arg value="-load-config"/>
      <arg value="etc/msoy-config.xml"/>
      <arg value="-use-network"/>
      <arg value="-compiler.source-path=${asrc.dir}/"/>
      <arg value="-output"/>
      <arg value="${deploy.dir}/embedstub-base.swf"/>
      <arg value="-file-specs"/>
      <arg value="${asrc.dir}/EmbedStub.as"/>
    </exec>
  </target>

  <target name="remixer" depends="asprepare">
    <antcall target="ascompile"><param name="astype" value="remixer"/></antcall>
  </target>

  <!-- builds our video viewer thingy -->
  <target name="videoviewer" depends="asprepare">
    <exec executable="${basedir}/bin/mxmlc" failonerror="true">
      <arg value="-load-config"/>
      <arg value="etc/msoy-config.xml"/>
      <arg value="-compiler.optimize"/>
      <arg value="-compiler.source-path=${asrc.dir}/"/>
      <arg value="-output"/>
      <arg value="${deploy.dir}/videoviewer.swf"/>
      <arg value="-file-specs"/>
      <arg value="${asrc.dir}/VideoViewer.as"/>
    </exec>
    <copy file="${deploy.dir}/videoviewer.swf" todir="pages/clients/${version}"/>
  </target>

  <!-- builds our neighborhood visualization client -->
  <target name="neighborhood">
    <ant dir="projects/neighborhood" target="dist" inheritAll="false"/>
    <copy file="${deploy.dir}/neighborhood.swf" todir="pages/clients/${version}"/>
  </target>

  <!-- builds our tutorial game -->
  <target name="tutorial" depends="prepare">
    <ant dir="projects/games/tutorial" target="dist" inheritAll="false"/>
    <copy file="${deploy.dir}/tutorial.swf" todir="pages/media/static/game"/>
  </target>

  <!-- builds, runs Proguard on and signs a Java client -->
  <target name="proguard">
    <echo>Building ${ident} Java client...</echo>

    <!-- figure out where the Java rt.jar file lives -->
    <condition property="rtClasses" value="${java.home}/../Classes/classes.jar">
      <istrue value="${platform.darwin}"/>
    </condition>
    <condition property="rtClasses" value="${java.home}/lib/rt.jar">
      <isfalse value="${platform.darwin}"/>
    </condition>
    <mkdir dir="${deploy.dir}"/>

    <!-- if we're skipping this client build, do so -->
    <if><contains string="${temp_skip_proguard}" substring="${ident}"/><then>
      <echo>Scratch that, skipping ${ident} build.</echo>

    </then><else>
      <!-- run Proguard -->
      <taskdef resource="proguard/ant/task.properties" classpath="${extlibs.dir}/proguard.jar"/>
      <proguard configuration="etc/${ident}-client.pro">
        <libraryjar name="${rtClasses}"/>
      </proguard>

      <!-- sign the lwjgl-enabled client -->
      <if><equals arg1="${ident}" arg2="lwjgl-game"/>
        <then>
          <!-- Sign the resulting jar file -->
          <if><isset property="cert_dir"/>
            <then>
              <property file="${cert_dir}/certificate.properties"/>
            </then>
            <else>
              <!-- No official keystore, use the development keystore -->
              <echo message="Signing with self-signed development certificate"/>
              <echo message="(cert_dir is not set, using development keystore)"/>
              <property name="sign.keystore" value="lib/dev-keystore.dat"/>
              <property name="sign.storepass" value="secret"/>
              <property name="sign.alias" value="threerings-dev"/>
            </else>
          </if>
          <signjar jar="${deploy.dir}/${ident}-client.jar" keystore="${sign.keystore}" lazy="true"
                   alias="${sign.alias}" storepass="${sign.storepass}"/>
        </then>
      </if>

      <!-- Copy the resulting jar file into the document tree. -->
      <copy file="${deploy.dir}/${ident}-client.jar" todir="pages/clients/${version}"/>
    </else></if>
  </target>

  <!-- builds our Java clients -->
  <property name="jclients" value="admin,game,lwjgl-game,swiftly"/>
  <target name="jclients" depends="dist"
          description="Rebuilds the Java clients. Use -Djclients=IDENT to just rebuild just one.">
    <for list="${jclients}" param="ident"><sequential>
      <antcall target="proguard"><param name="ident" value="@{ident}"/></antcall>
    </sequential></for>
    <!-- build the howdy pardner jar -->
    <jar file="pages/clients/${version}/howdy.jar" basedir="${classes.dir}">
      <include name="com/threerings/msoy/client/HowdyPardner.class"/>
    </jar>
  </target>

  <!-- builds top-level Java applications. -->
  <target name="javaapps" depends="jclients"/>

  <!-- generates fields for persistent record classes -->
  <target name="genrecord" depends="prepare">
    <taskdef name="grecord" classname="com.samskivert.jdbc.depot.tools.GenRecordTask"
             classpathref="classpath"/>
    <!-- make sure the record class files are all compiled -->
    <javac srcdir="${src.dir}" destdir="${classes.dir}" includeAntRuntime="false"
           debug="on" optimize="${build.optimize}" deprecation="on" target="1.5">
      <classpath refid="classpath"/>
      <include name="**/*Record.java"/>
    </javac>
    <!-- now update the source files -->
    <grecord classpathref="classpath">
      <fileset dir="${src.dir}" includes="**/*Record.java"/>
    </grecord>
  </target>

  <!-- generates additional methods for distributed object classes -->
  <target name="gendobj" depends="prepare">
    <taskdef name="dobj"
             classname="com.threerings.presents.tools.GenDObjectTask"
             classpathref="classpath"/>
    <!-- make sure the dobject class files are all compiled -->
    <javac srcdir="${src.dir}" destdir="${classes.dir}" includeAntRuntime="false"
           debug="on" optimize="${build.optimize}" deprecation="on" target="1.5">
      <classpath refid="classpath"/>
      <include name="**/*Object.java"/>
    </javac>
    <!-- now generate the associated files -->
    <dobj classpathref="classpath">
      <fileset dir="${src.dir}" includes="**/*Object.java"/>
    </dobj>
  </target>

  <!-- generates marshaller and dispatcher classes for all invocation service declarations -->
  <target name="genservice" depends="prepare">
    <taskdef name="service" classpathref="classpath"
             classname="com.threerings.presents.tools.GenServiceTask"/>
    <!-- make sure the service class files are all compiled -->
    <javac srcdir="${src.dir}" destdir="${classes.dir}" includeAntRuntime="false"
           debug="on" optimize="${build.optimize}" deprecation="on" target="1.5">
      <classpath refid="classpath"/>
      <include name="**/client/*Service.java"/>
      <exclude name="**/web/**"/>
    </javac>
    <!-- now generate the associated files -->
    <service header="lib/SOURCE_HEADER" asroot="${asrc.dir}" classpathref="classpath">
      <fileset dir="${src.dir}">
        <include name="**/client/*Service.java"/>
        <exclude name="**/web/**"/>
        <exclude name="**/peer/**"/>
        <exclude name="**/swiftly/**"/>
        <exclude name="**/GameServerService.java"/>
      </fileset>
    </service>
    <service header="lib/SOURCE_HEADER" classpathref="classpath">
      <fileset dir="${src.dir}">
        <include name="**/peer/client/*Service.java"/>
        <include name="**/swiftly/client/*Service.java"/>
        <include name="**/client/GameServerService.java"/>
      </fileset>
    </service>
  </target>

  <!-- generates sender and decoder classes for all invocation receiver declarations -->
  <target name="genreceiver" depends="prepare">
    <taskdef name="receiver" classpathref="classpath"
             classname="com.threerings.presents.tools.GenReceiverTask"/>
    <!-- make sure the receiver class files are all compiled -->
    <javac srcdir="${src.dir}" destdir="${classes.dir}" includeAntRuntime="false"
           debug="on" optimize="${build.optimize}" deprecation="on" target="1.5">
      <classpath refid="classpath"/>
      <include name="**/*Receiver.java"/>
    </javac>
    <!-- now generate the associated files -->
    <receiver header="lib/SOURCE_HEADER" classpathref="classpath">
      <fileset dir="${src.dir}">
        <include name="**/*Receiver.java"/>
      </fileset>
    </receiver>
  </target>

  <!-- adds readField and writeField methods to Stremable classes -->
  <target name="procstream">
    <taskdef name="instream" classpathref="classpath"
             classname="com.threerings.presents.tools.InstrumentStreamableTask"/>
    <!-- now instrument the associated files -->
    <instream outdir="${classes.dir}">
      <path refid="classpath"/>
      <!--<fileset dir="${classes.dir}" includes="**/data/*.class"/>-->
      <fileset dir="${classes.dir}" includes="**/data/**/*.class"/>
    </instream>
  </target>

  <!-- generates ActionScript versions of our Streamable classes -->
  <target name="genascript" depends="dist">
    <taskdef name="genscript" classpathref="classpath"
             classname="com.threerings.presents.tools.GenActionScriptTask"/>
    <!-- now generate the associated files -->
    <genscript header="lib/SOURCE_HEADER" asroot="${asrc.dir}">
      <fileset dir="${src.dir}">
        <include name="**/msoy/data/*.java"/>
        <include name="**/msoy/data/all/*.java"/>
        <include name="**/msoy/game/data/*.java"/>
        <exclude name="**/*CustomFieldSerializer.java"/> <!-- fucking GWT -->
        <exclude name="**/MemberName.java"/> <!-- alas, too fiddly -->
        <include name="**/msoy/item/data/all/*.java"/>
        <exclude name="**/Item.java"/> <!-- alas, too fiddly -->
        <exclude name="**/Game.java"/> <!-- alas, too fiddly -->
        <exclude name="**/MediaDesc.java"/> <!-- alas, too fiddly -->
        <exclude name="**/GameMemberInfo.java"/> <!-- can't handle WhirledOccupantInfo -->
        <include name="**/msoy/chat/data/*.java"/>
      </fileset>
    </genscript>
  </target>

  <!-- run the unit tests -->
  <target name="tests" depends="compile" description="Runs unit tests.">
    <!-- haul in our testing properties -->
    <if><isset property="msoy.test.propertyfile"/><then>
        <property file="${msoy.test.propertyfile}"/>
    </then><else>
        <property file="test.properties"/>
    </else></if>

    <mkdir dir="${basedir}/${deploy.dir}/tmp"/>
    <taskdef name="unit" classpathref="classpath"
      classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask"/>

      <unit printsummary="no" haltonfailure="yes" fork="yes" dir="${basedir}">
        <classpath refid="classpath"/>
        <formatter type="brief" usefile="false" unless="use.xml.output"/>
        <formatter type="xml" usefile="true" if="use.xml.output"/>

        <!-- Vend the test. properties -->
        <syspropertyset>
            <propertyref prefix="test."/>
        </syspropertyset>

        <!-- batch run our tests -->
        <batchtest todir="${basedir}/${deploy.dir}/tmp" unless="test">
          <fileset dir="${src.dir}">
            <include name="**/*UnitTest.java"/>

            <!-- XXX A nasty way to exclude S3 tests. This is fragile and
                 not-good, but I don't know of a better way to do it -->
            <exclude name="**/ProjectS3StorageUnitTest.java" unless="test.aws.id"/>
          </fileset>
        </batchtest>

        <!-- or run the requested test -->
        <test name="${test}" if="test"/>
      </unit>
  </target>

  <!-- build the java class files -->
  <target name="compile" depends="jprepare,facebook,qcompile"
    description="Builds java class files."/>

  <!-- builds the java class files only, without preparing the build directories etc. -->
  <target name="qcompile">
    <echo>Compiling MSOY...</echo>
    <javac srcdir="${src.dir}" destdir="${classes.dir}" includeAntRuntime="false"
           debug="on" optimize="off" deprecation="on" target="1.5">
      <classpath refid="classpath"/>
      <compilerarg value="-Xlint"/>
      <compilerarg value="-Xlint:-serial"/>
    </javac>
  </target>

  <!-- builds the javadoc documentation -->
  <target name="javadoc" depends="prepare,common-javadoc"/>

  <!-- builds the ActionScript documention -->
  <target name="asdoc">
    <mkdir dir="${deploy.dir}/asdocs"/>
    <java classpath="${flexsdk.dir}/lib/asdoc.jar" classname="flex2.tools.ASDoc" fork="true">
      <jvmarg value="-Xmx1024m"/>
      <jvmarg value="-Dsun.io.useCanonCashes=false"/>
      <jvmarg value="-Xbootclasspath/p:${flexsdk.dir}/asdoc/lib/xalan.jar"/>
      <jvmarg value="-Dos.name=Windows"/>
      <arg value="+flexlib=${flexsdk.dir}/frameworks"/>
      <arg line="-library-path ${flexsdk.dir}/frameworks/libs"/>
      <arg line="-library-path ${deploy.dir}/lib/tweener.swc"/>
      <arg line="-library-path ${deploy.dir}/lib/corelib.swc"/>
      <arg line="-library-path ${deploy.dir}/lib/flexlib.swc"/>
      <arg line="-library-path ${deploy.dir}/lib/naryalib-0.0-SNAPSHOT.swc"/>
      <arg line="-library-path ${deploy.dir}/lib/player-env-0.0-SNAPSHOT.swc"/>
      <arg line="-library-path ${deploy.dir}/lib/nenyalib-0.0-SNAPSHOT.swc"/>
      <arg line="-library-path ${deploy.dir}/lib/vilyalib-0.0-SNAPSHOT.swc"/>
      <arg line="-library-path ${deploy.dir}/lib/whirledlib-0.0-SNAPSHOT.swc"/>
      <arg line="-templates-path ${flexsdk.dir}/asdoc/templates"/>
      <arg line="-doc-sources ${asrc.dir}"/>
      <arg line="-output ${deploy.dir}/asdocs"/>
    </java>
  </target>

  <!-- convenience targets that build specific projects and copy the results -->
  <target name="facebook">
    <antcall target="distprojects"><param name="projects" value="facebook"/></antcall>
  </target>

  <!-- builds the distribution jar files -->
  <target name="dist" depends="prepare,compile,procstream">
    <!-- stick all our code in one jar file -->
    <jar file="${deploy.dir}/${app.name}-code.jar" basedir="${classes.dir}">
      <include name="com/**"/>
      <include name="*.properties"/>
      <include name="rsrc/**/*.properties"/>
      <include name="rsrc/**/*.tmpl"/>
      <exclude name="com/threerings/msoy/swiftly/server/build/FlexCompilerDelegate*"/>
    </jar>
    <!-- and all of our configuration and media in another -->
    <jar file="${deploy.dir}/${app.name}-media.jar" basedir="${classes.dir}" includes="rsrc/**"/>
    <!-- and our server-only data in yet another -->
    <jar file="${deploy.dir}/${app.name}-data.jar" basedir="." includes="data/dictionary/**"/>
    <!-- and our flex compiler delegate all by itself -->
    <jar file="${deploy.dir}/flex-compiler-delegate.jar" basedir="${classes.dir}"
         includes="com/threerings/msoy/swiftly/server/build/FlexCompilerDelegate*"/>
    <!-- copy some build results to where Swiftly wants them -->
    <copy todir="data/swiftly/whirled_sdk/lib">
      <fileset dir="${deploy.dir}/lib" includes="*.swc"/>
    </copy>
  </target>

  <!-- TODO: the tutorial target has been removed from flashapps until it compiles again after a
       the API shuffle is done, and the tutorial code has been refactored -->
  <!-- builds top-level flash applications. -->
  <target name="flashapps" depends="asprepare,mediastub,embedstub,videoviewer,remixer"
          description="Rebuilds all of our Flash clients and applets.">
    <antcall target="ascompile"><param name="astype" value="world"/></antcall>
    <antcall target="ascompile"><param name="astype" value="game"/></antcall>
  </target>

  <target name="distprojects-extra" depends="distprojects">
    <!-- this is not copied automatically :( -->
    <copy file="projects/thane/dist/avmthane" todir="dist/lib"/>

    <!-- executable permission must be set manually :( -->
    <chmod perm="oug+x" file="dist/lib/avmthane"/>
  </target>

  <!-- rebuilds all subprojects and the whole top-level distribution -->
  <target name="distbits" depends="distprojects-extra,dist,flashapps,thane-client,jclients"/>
  <target name="distall" depends="prepare,mavendeps,distbits,tests,checkstyle,gclient"
          description="Rebuilds all subprojects and whole top-level distribution."/>

  <!-- cleans out the compiled code -->
  <target name="clean" description="Cleans out compiled code.">
    <delete dir="${classes.dir}/com"/>
    <delete file="${src.dir}/com/threerings/msoy/data/all/DeploymentConfig.java"/>
  </target>

  <!-- cleans out the compiled ActionScript code and caches -->
  <target name="asclean">
    <delete><fileset dir="${asrc.dir}" includes="*.cache"/></delete>
    <delete file="${asrc.dir}/com/threerings/msoy/client/DeploymentConfig.as"/>
  </target>

  <!-- cleans out the compiled GWT bits and caches -->
  <target name="gclean">
    <delete dir="${gwtout.dir}"/>
  </target>

  <!-- fully cleans out all build results -->
  <target name="distclean" depends="clean,asclean,gclean">
    <delete dir="${deploy.dir}"/>
    <delete dir="pages/clients"/>
    <ant dir="projects/neighborhood" target="clean" inheritAll="false"/>
    <ant dir="projects/games/tutorial" target="clean" inheritAll="false"/>
    <ant dir="projects/mchooser" target="distclean" inheritAll="false"/>
    <delete file="pages/media/static/game/tutorial.swf"/>
    <delete file="pages/media/MediaStub.swf"/>
    <delete file="pages/index.html"/>
    <delete file="pages/crossdomain.xml"/>
    <for list="${gmsgs.list}" param="which"><sequential>
      <propertyregex property="file" input="@{which}" regexp="\." replace="/"/>
      <delete file="${gsrc.dir}/client/${file}Messages.java"/>
      <var name="file" unset="true"/>
    </sequential></for>
    <delete><fileset dir="data/swiftly/whirled_sdk/lib" includes="*.swc"/></delete>
  </target>

  <!-- fully cleans out the application and all subprojects -->
  <target name="distcleanall" depends="distcleanprojects,distclean"
        description="Fully cleans out the application and all subprojects."/>

  <!-- assigns a version number to this build -->
  <target name="assignversion">
    <var name="version" unset="true"/>
    <tstamp><format property="version" pattern="yyyyMMddHHmmss"/></tstamp>
    <echo>Assigned build version ${version}</echo>
  </target>

  <!-- defines properties needed by the individual foo-package targets -->
  <target name="prepare-package">
    <!-- define the directory from which we're going to build our packages -->
    <property name="pkgroot.root" value="${deploy.dir}/packages"/>
    <mkdir dir="${pkgroot.root}"/>
    <!-- TEMP: define where our .dpkg files will be written -->
    <propertycopy name="package.output" from="ooo.deprecated.package.deploy"/>
  </target>

  <!-- prepares and builds the msoy package(s) -->
  <target name="package" depends="assignversion,distall,prepare-package">

    <!-- define the root of our packages on the target machine -->
    <property name="app.prefix" value="${ooo.prefix}/${app.name}"/>

    <!-- define the root of the msoy-server-code package -->
    <property name="pkgroot.server.code" value="${pkgroot.root}/${app.name}-server-code"/>
    <property name="approot.server.code" value="${pkgroot.server.code}/${app.prefix}"/>
    <mkdir dir="${approot.server.code}"/>

    <!-- define the root of the msoy-server package -->
    <property name="pkgroot.server" value="${pkgroot.root}/${app.name}-server"/>
    <property name="approot.server" value="${pkgroot.server}/${app.prefix}"/>
    <mkdir dir="${approot.server}"/>

    <!-- define the root of the burl-server package -->
    <property name="pkgroot.burlserver" value="${pkgroot.root}/burl-server"/>
    <property name="approot.burlserver" value="${pkgroot.burlserver}/${app.prefix}"/>
    <mkdir dir="${approot.burlserver}"/>

    <!-- copy the external jars needed by the server -->
    <copy todir="${approot.server.code}/${deploy.dir}/lib">
      <fileset dir="${deploy.dir}/lib">
        <include name="*.jar"/>
      </fileset>
    </copy>

    <!-- copy the thane native binaries needed by all servers -->
    <copy todir="${approot.server.code}/bin/thane">
      <fileset dir="projects/thane/bin">
        <include name="*/avmthane"/>
      </fileset>
    </copy>

    <!-- copy this project's jar files and configuration -->
    <copy todir="${approot.server.code}/${deploy.dir}">
      <fileset dir="${deploy.dir}">
        <include name="*.jar"/>
        <exclude name="*-client.jar"/>
        <include name="*.properties"/>
        <include name="*.conf"/>
        <!-- skip files with secure information -->
        <exclude name="*-server.properties"/>
        <exclude name="*-server.conf"/>
        <include name="msoylib.abc"/>
        <include name="MsoyThaneClient.abc"/>
        <!-- skip build_settings.properties since it's only needed at build time -->
        <exclude name="build_settings.properties"/>
        <!-- skip conflicting libraries -->
        <exclude name="**/progruard.jar"/>
      </fileset>
    </copy>

    <!-- copy jars and configuration exclusive to msoy -->
    <copy todir="${approot.server}/${deploy.dir}">
      <fileset dir="${deploy.dir}">
        <include name="msoy-server.properties"/>
        <include name="msoy-server.conf"/>
        <include name="*.policy"/>
      </fileset>
    </copy>

    <!-- copy libs and config exclusive to burl -->
    <copy todir="${approot.burlserver}/${deploy.dir}">
      <fileset dir="${deploy.dir}">
        <include name="burl-server.properties"/>
        <include name="burl-server.conf"/>
      </fileset>
    </copy>

    <!-- copy various scripts needed by the all servers -->
    <copyfilelist dest="${approot.server.code}/bin">
      <filelist dir="bin">
        <file name="msoyjava"/>
        <file name="runcommon"/>
        <file name="runthaneclient"/>
      </filelist>
    </copyfilelist>

    <!-- copy various scripts needed by msoy only  -->
    <copyfilelist dest="${approot.server}/bin">
      <filelist dir="bin">
        <file name="msoy"/>
        <file name="msoyrespawn"/>
        <file name="runmsoy"/>
        <file name="rungame"/>
        <file name="swiftlycompiler"/>
        <file name="runpolicy"/>
      </filelist>
    </copyfilelist>

    <!-- copy various scripts needed by burl only -->
    <copyfilelist dest="${approot.burlserver}/bin">
      <filelist dir="bin">
        <file name="burl"/>
        <file name="burlrespawn"/>
        <file name="runburl"/>
      </filelist>
    </copyfilelist>

    <!-- copy in the swiftly build stuff (msoy only) -->
    <mkdir dir="${approot.server}/data"/>
    <copy todir="${approot.server}/data">
      <fileset dir="data">
        <include name="**"/>
        <exclude name="swiftly/flex_sdk/asdoc/**"/>
        <exclude name="swiftly/flex_sdk/runtimes/**"/>
        <exclude name="swiftly/flex_sdk/samples/**"/>
        <exclude name="swiftly/flex_sdk/templates/**"/>
      </fileset>
    </copy>

    <!-- need some xml files and the embed stub (msoy only) -->
    <copy file="${deploy.dir}/ehcache.xml" todir="${approot.server}/${deploy.dir}"/>
    <copy file="${deploy.dir}/antisamy-config.xml" todir="${approot.server}/${deploy.dir}"/>
    <copy file="${deploy.dir}/embedstub-base.swf" todir="${approot.server}/${deploy.dir}"/>

    <!-- create some runtime directories (all servers) -->
    <mkdir dir="${approot.server.code}/log/lighttpd"/>
    <mkdir dir="${approot.server.code}/logs"/>
    <mkdir dir="${approot.server.code}/run"/>

    <!-- create our production security.policy files (msoy only) -->
    <copy file="etc/security.policy.in" tofile="${approot.server}/${deploy.dir}/security.policy">
      <filterset>
        <filter token="PREFIX" value="${app.prefix}"/>
      </filterset>
    </copy>
    <copy file="etc/swiftly.policy.in" tofile="${approot.server}/${deploy.dir}/swiftly.policy">
      <filterset>
        <filter token="PREFIX" value="${app.prefix}"/>
      </filterset>
    </copy>

    <!-- set up our pages/ contents (msoy only) -->
    <copy todir="${approot.server}/pages">
      <fileset dir="pages">
        <exclude name="**/*.in"/>
        <exclude name="source/**"/>
        <exclude name="**/source/**"/>
      </fileset>
      <fileset dir="data" includes="whirled_sdk*.zip"/>
    </copy>
    <mkdir dir="${approot.server}/pages/buildresults"/>

    <!-- create our msoy server startup script (msoy only) -->
    <mkdir dir="${approot.server}/etc/rc.d"/>
    <startupscript name="msoy_server" runas="${msoy.user}"
                   output="${approot.server}/etc/rc.d/${app.name}-server.sh">
      <commands>
        <start cmdline="${app.prefix}/bin/msoy start"/>
        <stop cmdline="${app.prefix}/bin/msoy stop"/>
      </commands>
    </startupscript>

    <!-- create our policy server startup script (msoy only) -->
    <startupscript name="policy_server" runas="root"
                   pidfile="${app.prefix}/run/policy-server.pid"
                   output="${approot.server}/etc/rc.d/policy-server.sh">
      <command cmd="/usr/sbin/daemon" args="-f ${app.prefix}/bin/runpolicy" procname="*java*"/>
    </startupscript>

    <!-- create out bureau launcher startup script -->
    <mkdir dir="${approot.burlserver}/etc/rc.d"/>
    <startupscript name="msoy_bureau" runas="${burl.user}"
                   output="${approot.burlserver}/etc/rc.d/${app.name}-bureau.sh">
      <commands>
        <start cmdline="${app.prefix}/bin/burl start"/>
        <stop cmdline="${app.prefix}/bin/burl stop"/>
      </commands>
    </startupscript>

    <!-- build the actual Debian packages -->

    <!-- msoy-server-code -->
    <dpkg output="${pkgroot.root}" prefix="${app.prefix}" distribution="${ooo.distribution}">
      <package destroot="${pkgroot.server.code}">
        <info>
          <name>${app.name}-server-code</name>
          <version>${version}</version>
          <arch>${ooo.architecture}</arch>
          <description>Msoy Game Server Code</description>
          <maintainer>
            <name>${maintainer.name}</name>
            <email>${maintainer.email}</email>
          </maintainer>
        </info>
        <permissions>
          <permission user="root" group="${msoy.group}" mode="775" recursive="false">
            <path>log/</path>
            <path>logs/</path>
            <path>run/</path>
          </permission>
          <permission mode="555" recursive="true">
            <path>bin/</path>
            <path>etc/rc.d/</path>
          </permission>
        </permissions>
      </package>
    </dpkg>

    <!-- msoy-server -->
    <dpkg output="${pkgroot.root}" prefix="${app.prefix}" distribution="${ooo.distribution}">
      <package destroot="${pkgroot.server}">
        <info>
          <name>${app.name}-server</name>
          <version>${version}</version>
          <arch>${ooo.architecture}</arch>
          <description>Msoy Game Server</description>
          <maintainer>
            <name>${maintainer.name}</name>
            <email>${maintainer.email}</email>
          </maintainer>
        </info>
        <dependencies>
          <require package="msoy-server-code">
            <equalTo>${version}</equalTo>
          </require>
        </dependencies>
        <permissions>
          <permission user="${msoy.user}" group="${msoy.group}" mode="755" recursive="false">
            <path>pages/media/</path>
            <path>pages/buildresults/</path>
            <path>data/swiftly/projects/</path>
            <path>data/swiftly/build/</path>
          </permission>
          <permission mode="555" recursive="true">
            <path>bin/</path>
            <path>etc/rc.d/</path>
            <path>data/swiftly/flex_sdk_bin/bin</path>
          </permission>
          <permission user="${msoy.user}" group="${msoy.group}" mode="550">
            <path>dist/msoy-server.properties</path>
          </permission>
        </permissions>
      </package>
    </dpkg>

    <!-- burl-server -->
    <dpkg output="${pkgroot.root}" prefix="${app.prefix}" distribution="${ooo.distribution}">
      <package destroot="${pkgroot.burlserver}">
        <info>
          <name>burl-server</name>
          <version>${version}</version>
          <arch>${ooo.architecture}</arch>
          <description>Msoy Bureau Server</description>
          <maintainer>
            <name>${maintainer.name}</name>
            <email>${maintainer.email}</email>
          </maintainer>
        </info>
        <dependencies>
          <require package="msoy-server-code">
            <equalTo>${version}</equalTo>
          </require>
        </dependencies>
        <permissions>
          <permission mode="555" recursive="true">
            <path>bin/</path>
            <path>etc/rc.d/</path>
          </permission>
          <permission user="${burl.user}" group="${msoy.group}" mode="550">
            <path>dist/burl-server.properties</path>
          </permission>
        </permissions>
      </package>
    </dpkg>

    <!-- now that all of our packages are generated, move them into place all at once -->
    <move todir="${package.output}">
      <fileset dir="${pkgroot.root}" includes="*.dpkg"/>
    </move>
  </target>

  <!-- builds our javadocs and packages them up (TODO: enable asdoc) -->
  <target name="package-docs" depends="distall,javadoc,prepare-package">
    <property name="pkgroot.docs" value="${pkgroot.root}/msoy-docs"/>
    <property name="approot.docs" value="${pkgroot.docs}/${ooo.docs.prefix}"/>

    <!-- copy our built documentation into place -->
    <mkdir dir="${approot.docs}"/>
    <copy todir="${approot.docs}/msoy">
      <fileset dir="${deploy.dir}/docs"/>
    </copy>
    <!-- TODO: enable this when asdoc is not fucked
    <copy todir="${approot.docs}/msoy-as">
      <fileset dir="${deploy.dir}/asdocs"/>
    </copy> -->

    <!-- Set up a version number to use for docs package. -->
    <tstamp><format property="docsVersion" pattern="yyyyMMddHHmmss"/></tstamp>

    <dpkg output="${package.output}" prefix="${ooo.docs.prefix}" distribution="${ooo.distribution}">
      <package destroot="${pkgroot.docs}">
        <info>
          <name>msoy-docs</name>
          <version>${docsVersion}</version>
          <arch>${ooo.architecture}</arch>
          <description>Msoy Development Docs</description>
          <maintainer>
            <name>${maintainer.name}</name>
            <email>${maintainer.email}</email>
          </maintainer>
        </info>
      </package>
    </dpkg>
  </target>

</project>
